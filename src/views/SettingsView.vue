<script setup>
import { ref, onMounted, computed, inject } from 'vue'
import { useDisplay } from 'vuetify'
import { useRouter } from 'vue-router'
import { useTheme } from 'vuetify'
import { 
  updateProfile, 
  updatePassword,
  EmailAuthProvider,
  reauthenticateWithCredential,
  deleteUser,
  signOut
} from 'firebase/auth'
import { auth, db, updateUserInfo, deleteUserAccount } from '@/firebase'

const showAlert = inject('showAlert')
const showLoading = inject('showLoading')
const showLogoutDialog = ref(false)
const { mobile } = useDisplay()

const router = useRouter()
const theme = useTheme()
const isDark = computed({
  get: () => theme.global.current.value.dark,
  set: (value) => {
    theme.global.name.value = value ? 'dark' : 'light'
    localStorage.setItem('theme', value ? 'dark' : 'light')
  }
})

const form = ref(null)
const showCurrentPassword = ref(false)
const showNewPassword = ref(false)

// Ìèº Îç∞Ïù¥ÌÑ∞
const displayName = ref(auth.currentUser?.displayName || '')
const currentPassword = ref('')
const newPassword = ref('')

// ÎπÑÎ∞ÄÎ≤àÌò∏ Í∑úÏπô
const passwordRules = [
  v => !!v || 'ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî',
  v => v?.length >= 16 || 'ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÏµúÏÜå 16Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï¥Ïöî',
  v => /[A-Z]/.test(v) || 'ÎåÄÎ¨∏ÏûêÎ•º Ìè¨Ìï®Ìï¥Ïïº Ìï¥Ïöî',
  v => /[a-z]/.test(v) || 'ÏÜåÎ¨∏ÏûêÎ•º Ìè¨Ìï®Ìï¥Ïïº Ìï¥Ïöî',
  v => /[0-9]/.test(v) || 'Ïà´ÏûêÎ•º Ìè¨Ìï®Ìï¥Ïïº Ìï¥Ïöî',
  v => /[!@#$%^&*]/.test(v) || 'ÌäπÏàòÎ¨∏Ïûê(!@#$%^&*)Î•º Ìè¨Ìï®Ìï¥Ïïº Ìï¥Ïöî'
]

// Í≥ÑÏ†ï ÏÇ≠Ï†ú Í¥ÄÎ†® ÏÉÅÌÉú
const showDeleteDialog = ref(false)
const deleteConfirmText = ref('')
const deleteLoading = ref(false)
const deletePassword = ref('')
const CONFIRM_TEXT = 'Í≥ÑÏ†ï ÏÇ≠Ï†ú'

onMounted(() => {
  if (auth.currentUser) {
    displayName.value = auth.currentUser.displayName || ''
  }
})

const handleUpdateProfile = async () => {
  if (!form.value.validate()) return
  
  localLoading.value = true
  try {
    await updateProfile(auth.currentUser, {
      displayName: displayName.value,
      photoURL: auth.currentUser.photoURL
    })
    
    await updateUserInfo(auth.currentUser.uid, {
      displayName: displayName.value,
      handle: auth.currentUser.photoURL
    })
    
    showAlert('ÌîÑÎ°úÌïÑÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏñ¥Ïöî!üéâ')
  } catch (e) {
    console.error('Error updating profile:', e)
    showAlert('ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî.', 'error')
  } finally {
    localLoading.value = false
  }
}

const updateUserPassword = async () => {
  const { valid } = await form.value.validate()
  if (!valid) return
  if (!currentPassword.value || !newPassword.value) return
  
  localLoading.value = true
  try {
    // Ïû¨Ïù∏Ï¶ù
    const credential = EmailAuthProvider.credential(
      auth.currentUser.email,
      currentPassword.value
    )
    await reauthenticateWithCredential(auth.currentUser, credential)
    
    // ÎπÑÎ∞ÄÎ≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏
    await updatePassword(auth.currentUser, newPassword.value)
    
    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏñ¥Ïöî! üéâ')
    currentPassword.value = ''
    newPassword.value = ''
  } catch (e) {
    console.error(e)
    if (e.code === 'auth/wrong-password') {
      showAlert('ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏïÑÏöî!', 'error')
    } else {
      showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî.', 'error')
    }
  } finally {
    localLoading.value = false
  }
}

const handleDeleteAccount = async () => {
  if (deleteConfirmText.value !== CONFIRM_TEXT) return
  if (!deletePassword.value) {
    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!', 'error')
    return
  }
  
  deleteLoading.value = true
  try {
    // Ïû¨Ïù∏Ï¶ù ÌïÑÏöî
    const credential = EmailAuthProvider.credential(
      auth.currentUser.email,
      deletePassword.value
    )
    await reauthenticateWithCredential(auth.currentUser, credential)
    
    // Î™®Îì† ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
    await deleteUserAccount(auth.currentUser.uid)
    
    // Firebase Auth Í≥ÑÏ†ï ÏÇ≠Ï†ú
    await deleteUser(auth.currentUser)
    router.push('/')
  } catch (e) {
    console.error('Error deleting account:', e)
    if (e.code === 'auth/requires-recent-login') {
      showAlert('Î≥¥ÏïàÏùÑ ÏúÑÌï¥ Îã§Ïãú Î°úÍ∑∏Ïù∏Ìïú ÌõÑ ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî!', 'error')
    } else if (e.code === 'auth/wrong-password') {
      showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏïÑÏöî!', 'error')
    } else {
      showAlert('Í≥ÑÏ†ï ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî.', 'error')
    }
  } finally {
    deleteLoading.value = false
    deleteConfirmText.value = ''
    deletePassword.value = ''
  }
}

const handleLogout = async () => {
  localLoading.value = true
  try {
    await signOut(auth)
    await router.push('/')
    showAlert('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏñ¥Ïöî. Îã§ÏùåÏóê Îòê ÎßåÎÇòÏöî! üëã')
  } catch (error) {
    console.error('Error logging out:', error)
    showAlert('Î°úÍ∑∏ÏïÑÏõÉ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî.', 'error')
  } finally {
    localLoading.value = false
  }
}

const openLogoutConfirm = () => {
  showLogoutDialog.value = true
}
</script>

<template>
  <v-container>
    <v-row justify="center">
      <v-col cols="12" sm="8" md="6">
        <!-- Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÏàòÏ†ï -->
        <v-card class="mb-4">
          <v-card-title>Ïù∏ÌÑ∞ÌéòÏù¥Ïä§</v-card-title>
          <v-card-text>
            <v-list>
              <v-list-item>
                <template v-slot:prepend>
                  <v-icon>mdi-brightness-6</v-icon>
                </template>
                <v-list-item-title>
                  <v-tooltip location="right" text="Î∞ùÏùÄ/Ïñ¥ÎëêÏö¥ ÌÖåÎßàÎ•º Î≥ÄÍ≤ΩÌï¥Ïöî">
                    <template v-slot:activator="{ props }">
                      <span v-bind="props">ÌÖåÎßà Î≥ÄÍ≤ΩÌïòÍ∏∞</span>
                    </template>
                  </v-tooltip>
                </v-list-item-title>
                <template v-slot:append>
                  <v-switch
                    v-model="isDark"
                    hide-details
                    inset
                  ></v-switch>
                </template>
              </v-list-item>
            </v-list>
          </v-card-text>
        </v-card>

        <!-- Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÏïàÎÇ¥ Î©îÏãúÏßÄ ÌëúÏãú -->
        <v-alert
          v-if="!auth.currentUser"
          type="info"
          class="mb-4"
          :v-btn rounded="lg"
        >
          Í≥ÑÏ†ï ÏÑ§Ï†ïÏùÑ Î≥¥Î†§Î©¥ Î°úÍ∑∏Ïù∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî.
        </v-alert>

        <!-- Í≥ÑÏ†ï ÏÑ§Ï†ï (Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÎßå) -->
        <template v-if="auth.currentUser">
          <!-- Í≥ÑÏ†ï ÏÑπÏÖò -->
          <v-card class="mb-4">
            <v-card-title>Í≥ÑÏ†ï</v-card-title>
            <v-card-text>
              <v-list>
                <!-- Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº -->
                <v-list-item>
                  <template v-slot:prepend>
                    <v-icon>mdi-logout</v-icon>
                  </template>
                  <v-list-item-title>Î°úÍ∑∏ÏïÑÏõÉ</v-list-item-title>
                  <template v-slot:append>
                    <v-btn
                      color="primary"
                      variant="text"
                      @click="openLogoutConfirm"
                      :loading="loading"
                    >
                      Î°úÍ∑∏ÏïÑÏõÉ
                    </v-btn>
                  </template>
                </v-list-item>
                
                <!-- Í≥ÑÏ†ï ÏÇ≠Ï†ú Î≤ÑÌäº -->
                <v-list-item>
                  <template v-slot:prepend>
                    <v-icon color="error">mdi-delete</v-icon>
                  </template>
                  <v-list-item-title class="text-error">Í≥ÑÏ†ï ÏÇ≠Ï†ú</v-list-item-title>
                  <template v-slot:append>
                    <v-btn
                      color="error"
                      variant="text"
                      @click="showDeleteDialog = true"
                    >
                      Í≥ÑÏ†ï ÏÇ≠Ï†ú
                    </v-btn>
                  </template>
                </v-list-item>
              </v-list>
            </v-card-text>
          </v-card>

          <!-- ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï -->
          <v-card class="mb-4">
            <v-card-title>ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</v-card-title>
            <v-card-text>
              <v-form @submit.prevent="handleUpdateProfile" ref="form">
                <v-text-field
                  v-model="displayName"
                  label="ÌëúÏãú Ïù¥Î¶Ñ"
                  required
                  :rules="[v => !!v || 'ÌëúÏãú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî']"
                ></v-text-field>
                
                <v-btn
                  color="primary"
                  type="submit"
                  :loading="loading"
                  :disabled="!displayName.trim()"
                >
                  ÌëúÏãú Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
                </v-btn>
              </v-form>
            </v-card-text>
          </v-card>

          <!-- ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω -->
          <v-card class="mb-4">
            <v-card-title>ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</v-card-title>
            <v-card-text>
              <v-form ref="form" @submit.prevent="updateUserPassword">
                <v-text-field
                  v-model="currentPassword"
                  label="ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏"
                  :type="showCurrentPassword ? 'text' : 'password'"
                  :append-inner-icon="showCurrentPassword ? 'mdi-eye-off' : 'mdi-eye'"
                  @click:append-inner="showCurrentPassword = !showCurrentPassword"
                  required
                ></v-text-field>
                
                <v-text-field
                  v-model="newPassword"
                  label="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏"
                  :type="showNewPassword ? 'text' : 'password'"
                  :append-inner-icon="showNewPassword ? 'mdi-eye-off' : 'mdi-eye'"
                  @click:append-inner="showNewPassword = !showNewPassword"
                  required
                  :rules="passwordRules"
                  hint="ÎåÄÏÜåÎ¨∏Ïûê, Ïà´Ïûê, ÌäπÏàòÎ¨∏Ïûê(!@#$%^&*)Î•º Ï°∞Ìï©ÌïòÏó¨ 16Ïûê Ïù¥ÏÉÅ"
                  persistent-hint
                ></v-text-field>
                
                <v-btn
                  color="primary"
                  type="submit"
                  :loading="loading"
                  :disabled="!currentPassword || !newPassword"
                  class="mt-4"
                >
                  ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                </v-btn>
              </v-form>
            </v-card-text>
          </v-card>

          <!-- Í≥ÑÏ†ï ÏÇ≠Ï†ú ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
          <v-dialog v-model="showDeleteDialog" max-width="500">
            <v-card>
              <v-card-title class="text-error">
                ‚ö†Ô∏è Í≥ÑÏ†ï ÏòÅÍµ¨ ÏÇ≠Ï†ú
              </v-card-title>
              <v-card-text>
                <p class="text-body-1 mb-4">
                  <strong>Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏñ¥Ïöî!</strong> Îã§ÏùåÍ≥º Í∞ôÏùÄ Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê† Í±∞ÏòàÏöî:
                </p>
                <ul class="mb-4">
                  <li>Î™®Îì† Í≤åÏãúÎ¨º Î∞è ÎåìÍ∏Ä</li>
                  <li>ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥</li>
                  <li>ÌôúÎèô Í∏∞Î°ù</li>
                  <li>Í∏∞ÌÉÄ Î™®Îì† Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞</li>
                </ul>
                <p class="text-body-1 mb-4">
                  Í≥ÑÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÎ†§Î©¥ ÏïÑÎûòÏóê <strong>'{{ CONFIRM_TEXT }}'</strong>Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
                </p>
                <v-text-field
                  v-model="deleteConfirmText"
                  label="ÌôïÏù∏ Î¨∏Íµ¨ ÏûÖÎ†•"
                  :rules="[v => v === CONFIRM_TEXT || 'Ï†ïÌôïÌïú Î¨∏Íµ¨Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî']"
                  variant="outlined"
                  density="comfortable"
                ></v-text-field>
                <v-text-field
                  v-model="deletePassword"
                  label="Í≥ÑÏ†ï ÎπÑÎ∞ÄÎ≤àÌò∏"
                  type="password"
                  variant="outlined"
                  density="comfortable"
                  :rules="[v => !!v || 'ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî']"
                ></v-text-field>
              </v-card-text>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn
                  variant="text"
                  @click="showDeleteDialog = false"
                >
                  Ï∑®ÏÜå
                </v-btn>
                <v-btn
                  color="error"
                  :loading="deleteLoading"
                  :disabled="deleteConfirmText !== CONFIRM_TEXT"
                  @click="handleDeleteAccount"
                >
                  Í≥ÑÏ†ï ÏòÅÍµ¨ ÏÇ≠Ï†ú
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-dialog>

          <!-- Î°úÍ∑∏ÏïÑÏõÉ ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
          <v-dialog
            v-model="showLogoutDialog"
            :fullscreen="mobile"
            :transition="mobile ? 'dialog-bottom-transition' : 'dialog-transition'"
            max-width="400"
            class="logout-dialog"
          >
            <v-card :class="{ 'mobile-dialog': mobile }">
              <v-card-title class="text-center pa-4">
                <v-icon size="48" color="primary" class="mb-2">mdi-logout</v-icon>
                <div class="text-h5">Ï†ïÎßêÎ°ú Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†Ïñ¥Ïöî?!?!</div>
              </v-card-title>
              
              <v-card-text class="text-center pb-4">
                <p class="text-body-1">Ïû†Ïãú Ïâ¨ÏóàÎã§ Ïò§ÏãúÎÇòÏöî?</p>
                <p class="text-body-2">Ïñ∏Ï†úÎì† Îã§Ïãú Î°úÍ∑∏Ïù∏ÌïòÏã§ Ïàò ÏûàÏñ¥Ïöî.</p>
              </v-card-text>
              
              <v-card-actions class="pa-4">
                <v-row>
                  <v-col cols="12" :sm="6">
                    <v-btn
                      block
                      variant="outlined"
                      @click="showLogoutDialog = false"
                      class="mb-2 mb-sm-0"
                    >
                      ÎèåÏïÑÍ∞àÎûòÏöî
                    </v-btn>
                  </v-col>
                  <v-col cols="12" :sm="6">
                    <v-btn
                      block
                      color="primary"
                      @click="handleLogout"
                      :loading="loading"
                    >
                      ÎÑ§, Ìï†ÎûòÏöî
                    </v-btn>
                  </v-col>
                </v-row>
              </v-card-actions>
            </v-card>
          </v-dialog>
        </template>
      </v-col>
    </v-row>
  </v-container>
</template>

<style scoped>
.bg-error-lighten-5 {
  background-color: rgb(255, 235, 238) !important;
}

/* Î™®Î∞îÏùº Îã§Ïù¥ÏñºÎ°úÍ∑∏ Ïä§ÌÉÄÏùº */
.mobile-dialog {
  position: absolute;
  bottom: 0;
  margin: 0;
  padding-bottom: env(safe-area-inset-bottom);
  border-radius: 24px 24px 0 0;
}

/* Îç∞Ïä§ÌÅ¨ÌÜ± Îã§Ïù¥ÏñºÎ°úÍ∑∏ Ïä§ÌÉÄÏùº */
.v-dialog:not(.v-dialog--fullscreen) .v-card {
  border-radius: 16px;
}
</style> 